<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <!-- The above 4 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <!-- Title -->
    <title>Blue Resort & Hotel</title>

    <!-- Favicon -->
    <link rel="icon" href="../img/core-img/favicon.ico" />

    <!-- Core Stylesheet -->
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="../css/breadcrumb.css" type="text/css" />
  </head>

  <body>
    <!-- Preloader -->
    <div class="preloader d-flex align-items-center justify-content-center">
      <div class="cssload-container">
        <div class="cssload-loading"><i></i><i></i><i></i><i></i></div>
      </div>
    </div>

    <!-- ##### Header Area Start ##### -->
    <header class="header-area">
      <!-- Navbar Area -->
      <div class="palatin-main-menu">
        <div class="classy-nav-container breakpoint-off">
          <div class="container">
            <!-- Menu -->
            <nav class="classy-navbar justify-content-between" id="palatinNav">
              <!-- Nav brand -->
              <a href="../index.html" class="nav-brand"
                ><img src="../img/core-img/logo.png" alt=""
              /></a>

              <!-- Navbar Toggler -->
              <div class="classy-navbar-toggler">
                <span class="navbarToggler"
                  ><span></span><span></span><span></span
                ></span>
              </div>

              <!-- Menu -->
              <div class="classy-menu">
                <!-- close btn -->
                <div class="classycloseIcon">
                  <div class="cross-wrap">
                    <span class="top"></span><span class="bottom"></span>
                  </div>
                </div>

                <!-- Nav Start -->
                <div class="classynav">
                  <ul>
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="../rooms.html">Rooms</a></li>
                    <li><a href="../gallery.html">Gallery</a></li>
                    <li><a href="../about-us.html">About Us</a></li>
                    <li class="active">
                      <a href="../contact.html">Contact</a>
                    </li>
                  </ul>

                  <!-- Button -->
                  <div class="menu-btn">
                    <a href="../myBooking.html" class="btn palatin-btn"
                      >My Booking <i class="fa fa-search" aria-hidden="true"></i
                    ></a>
                  </div>
                </div>
                <!-- Nav End -->
              </div>
            </nav>
          </div>
        </div>
      </div>
    </header>
    <!-- ##### Header Area End ##### -->

    <!-- ##### Breadcumb Area Start ##### -->

    <section class="contact-form-area mb-100">
      <div class="container" style="margin-top: 10rem !important">
        <div class="bread">
          <div class="breadcrumb-pagination">
            <div class="completed">
              <a href="../index.html">
                <span>1</span>
                <p>Select Dates</p>
              </a>
            </div>
            <div class="active">
              <a href="select_rooms.html">
                <span>2</span>
                <p>Rooms</p>
              </a>
            </div>
            <div class="todo">
              <span>3</span>
              <p>Guest Detail</p>
            </div>
            <div class="todo">
              <span>4</span>
              <p>Review</p>
            </div>
            <div class="todo">
              <span>5</span>
              <p>Confirmation</p>
            </div>
          </div>
        </div>

        <div class="row">
          <div id="room_row" class="col-lg-8"></div>
          <div class="col-lg-4">
            <div
              class="card mt-2 bg-light"
              style="width: 20rem"
              id="card-rooms"
            >
              <div class="card-body">
                <h2 class="card-title">Your Stay</h2>
                <div class="row">
                  <div class="col-6">
                    <span><b>Check-In</b></span>
                  </div>
                  <div class="col-6">
                    <span><b>Check-Out</b></span>
                  </div>
                </div>
                <div class="row">
                  <div class="col-6">
                    <span>2:00 PM</span>
                  </div>
                  <div class="col-6">
                    <span>11:00 AM</span>
                  </div>
                </div>
              </div>

              <div class="room_selected">
                <div class="dropdown-divider ml-4 mr-4"></div>
                <table
                  class="table table-borderless table-sm ml-2"
                  id="invoice"
                >
                  <thead>
                    <tr>
                      <th>Room</th>
                      <th>Qty</th>
                      <th>Price</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="card-body">
                <h5 class="text-dark">Subtotal : <b id="sub_total"></b></h5>
                <div class="dropdown-divider"></div>
                <button class="btn btn-info mr-2" id="continue">
                  Continue
                </button>
                <button class="btn btn-danger ml-2" id="reset">Reset</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- ##### Contact Form Area End ##### -->

    <!-- ##### Google Maps ##### -->

    <!-- ##### Footer Area Start ##### -->
    <footer class="footer-area">
      <div class="container">
        <div class="row pt-5">
          <p class="col-md-8 text-left">
            Copyright Â©
            <script>
              document.write(new Date().getFullYear());
            </script>
            2021 All rights reserved | Blue Garden Resort
          </p>
          <p class="col-md-4 text-right social">
            <!-- <a href=""><span class="fa fa-tripadvisor"></span></a> -->
            <a href="https://www.facebook.com/blugarden" target="_blank"
              ><span class="fa fa-facebook"></span
            ></a>
            <!-- <a href="#"><span class="fa fa-twitter"></span></a>
            <a href="#"><span class="fa fa-linkedin"></span></a>
            <a href="#"><span class="fa fa-vimeo"></span></a> -->
          </p>
        </div>
      </div>
    </footer>
    <!-- ##### Footer Area End ##### -->

    <!-- ##### All Javascript Script ##### -->
    <!-- jQuery-2.2.4 js -->
    <script src="../js/jquery/jquery-2.2.4.min.js"></script>
    <!-- Popper js -->
    <script src="../js/bootstrap/popper.min.js"></script>
    <!-- Bootstrap js -->
    <script src="../js/bootstrap/bootstrap.min.js"></script>
    <!-- All Plugins js -->
    <script src="../js/plugins/plugins.js"></script>
    <!-- Active js -->
    <script src="../js/active.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
    <script src="../admin/dist/js/update_expire_noshow.js"></script>
  </body>

  <script>
    if (
      sessionStorage.getItem("checkin_date") == null ||
      sessionStorage.getItem("checkout_date") == null
    )
      window.location = "../index.html";

    let date_from = new Date(sessionStorage.getItem("checkin_date"));
    let date_to = new Date(sessionStorage.getItem("checkout_date"));

    var Difference_In_Time = date_to.getTime() - date_from.getTime();
    var nights = Difference_In_Time / (1000 * 3600 * 24);

    let reqr_roomtype = (function () {
      var tmp = null;
      $.ajax({
        async: false,
        url: "../php_functions/get_roomtype.php",
        type: "POST",
        success: function (data) {
          tmp = data;
        },
      });
      return JSON.parse(tmp);
    })();

    let req_rooms = (function () {
      var tmp = null;
      $.ajax({
        async: false,
        url: "../php_functions/get_rooms.php",
        data:
          "check_in=" +
          sessionStorage.getItem("checkin_date") +
          "&check_out=" +
          sessionStorage.getItem("checkout_date"),
        type: "POST",
        success: function (data) {
          tmp = data;
        },
      });
      return JSON.parse(tmp);
    })();

    reqr_roomtype.map((roomtype) => {
      let counter_rooms = 0;
      req_rooms.map((rooms) => {
        if (rooms.roomtype_id == roomtype.roomtype_id) {
          counter_rooms += 1;
        } else {
        }
      });

      let option = "";

      if (counter_rooms == 0) {
        option = "<option value='0'>No available room</option>";
      } else {
        for (i = 1; counter_rooms >= i; i++) {
          option += "<option value=" + i + ">" + i + "</option>";
        }
      }

      const formatter = new Intl.NumberFormat("en-IN", {
        style: "currency",
        currency: "PHP",
        minimumFractionDigits: 2,
      });

      $("#room_row").append(
        $(
          '<div class="room-details-item" id="view' +
            roomtype.roomtype_id +
            '">' +
            '<img src ="../admin/dist/img/room/' +
            roomtype.roomtype_photo +
            '" style="    width: 100%; height: 461px;" alt = ""/>' +
            '<div class="rd-text"><div class="rd-title"><h3>' +
            roomtype.roomtype_name +
            '</h3><div class="rdt-right"> <form class="add-room"><div class="row">' +
            '<input value="' +
            roomtype.roomtype_id +
            '" hidden/><input value="' +
            roomtype.roomtype_price +
            '" hidden/><input value="' +
            roomtype.roomtype_name +
            '" hidden/><input value="' +
            roomtype.roomtype_capacity +
            '"hidden/>' +
            '<div class="col-8"> ' +
            '<select class="form-control" id=room' +
            roomtype.roomtype_id +
            ' required><option value="" selected hidden disabled>Select Avail. Rooms</option>' +
            option +
            "</select> <p class='text-center'><em>( " +
            counter_rooms +
            " left)</em></p> </div>" +
            '<div class="col-4"><button class="room' +
            roomtype.roomtype_id +
            ' btn btn-primary" id=room' +
            roomtype.roomtype_id +
            ">ADD</button></div></div> </form>" +
            "</div> " +
            "</div> " +
            "<h2>" +
            formatter.format(roomtype.roomtype_price) +
            "<span> / Per night</span></h2> " +
            "<table> " +
            "<tbody>" +
            "<tr> " +
            '<td class="r-o">Capacity:</td> ' +
            "<td>Max person " +
            roomtype.roomtype_capacity +
            "</td>" +
            " </tr>" +
            "<tr> " +
            '<td class="r-o">Description:</td>' +
            " <td>" +
            roomtype.description +
            "</td>" +
            " </tr>" +
            " </tbody>" +
            " </table>" +
            " </div>" +
            " </div >"
        )
      );
    });

    let selected_array = [];
    let sub_total = 0;

    //add_selected
    $(".add-room").submit(function (e) {
      e.preventDefault();
      if (e.target[4].value != 0) {
        let roomtype_id = e.target[0].value;
        let roomtype_price = e.target[1].value;
        let roomtype_name = e.target[2].value;
        let roomtype_capacity = e.target[3].value;
        let num_rooms = e.target[4].options.selectedIndex;

        let new_price = roomtype_price * num_rooms * nights;
        let new_capacity = roomtype_capacity * num_rooms;
        let selected_object = {};

        let selected_rooms = [];

        let counter = 1;
        req_rooms.map((rooms) => {
          if (rooms.roomtype_id == roomtype_id && counter <= num_rooms) {
            selected_rooms.push(rooms.room_id);
            counter++;
          }
        });

        selected_object.roomtype_id = roomtype_id;
        selected_object.roomtype_name = roomtype_name;
        selected_object.num_rooms = num_rooms;
        selected_object.new_capacity = new_capacity;
        selected_object.new_price = new_price;
        selected_object.room_ids = selected_rooms;

        selected_array.push(selected_object);

        $("#room" + roomtype_id).attr("disabled", "disabled");
        $(".room" + roomtype_id).attr("disabled", "disabled");

        $("#invoice > tbody:last-child").append(
          "<tr id='" +
            roomtype_id +
            "'>" +
            "<th>" +
            roomtype_name +
            "</th>" +
            "<td>" +
            num_rooms +
            "</td>" +
            "<td>PHP " +
            formatter.format(new_price) +
            "</td>" +
            "<td>" +
            '<button class="btn' +
            roomtype_id +
            ' btn btn-default">' +
            '<i class="fa fa-times"></i>' +
            "</button>" +
            "</td>" +
            "</tr>"
        );
        $(".btn" + roomtype_id).attr(
          "onclick",
          "deleteselected(" + roomtype_id + ")"
        );

        sub_total += new_price;
        $("#sub_total").html(formatter.format(sub_total));
      } else {
        Swal.fire({
          icon: "info",
          title: "Oops...",
          text: "This type of room has no available room, Try another booking dates",
        });
      }
    });

    deleteselected = (e) => {
      let room_id = e;
      let new_object = {};

      selected_array = selected_array.filter(check_selected);

      function check_selected(item, index, array) {
        if (item.roomtype_id != room_id) {
          return item;
        } else if (item.roomtype_id == room_id) {
          sub_total = sub_total - item.new_price;
        }
      }
      $("#sub_total").html(sub_total);
      //console.log(room_id[0])
      console.log(selected_array);
      $("#" + room_id).remove();
      $("#room" + room_id).removeAttr("disabled", "disabled");
      $(".room" + room_id).removeAttr("disabled", "disabled");
    };

    //continue
    $("#continue").click((e) => {
      console.log(selected_array);
      if (selected_array.length != 0) {
        sessionStorage.setItem("room_details", JSON.stringify(selected_array));

        window.location = "guest-details.html";
      } else {
        Swal.fire({
          icon: "warning",
          title: "You forgot something?",
          text: "Please select room first!",
        });
      }
    });

    $("#reset").click((e) => {
      Swal.fire({
        icon: "warning",
        title: "Are you sure you want to reset?",
        confirmButtonColor: "#3085d6",
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.reload();
        }
      });
    });
  </script>
</html>
